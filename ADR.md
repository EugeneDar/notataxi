## ADR

Архревьюер: TODO кто?

#### Какую задачу мы решаем?

Разрабатываем сервис хранения и обработки информации о заказах.


#### Доменная область

TODO Что это? Мб не писать?


#### Пользовательские сценарии

TODO переформулировать вообще все предложения в adr в наклонении "наш сервис должен...", а не "наш сервис уже...".

У нашего сервиса должно быть два вида пользователей: заказчики и исполнители. Заказчики создают и отменяют заказы, а исполнители получают информацию о назначенных им заказах.

Запросы от заказчиков должны приходить в наш сервис проходя через сторонний сервис, который назначает заказы исполнителям. Поэтому наш сервис не должен заниматься назначением заказов исполнителям.


#### Функциональные требования

###### Роли пользователей

- Заказчик
- Исполнитель заказов

###### Сценарии использования

- Заказчики будут создавать заказы, внешний с нашей точки зрения сервис будет назначать их исполнителям и присылать нам запрос о заказе от такого-то пользователя с таким-то исполнителем. Если приходит запрос на назначение заказа исполнителю, который уже исполняет какой-то заказ, то ему должен назначаться новый, а старый должен получать статус завершенного. Таким образом на каждый заказ должен назначаться ровно один исполнитель, и на каждого исполнителя одновременно должно быть назначено не больше одного заказа.
- Исполнители постоянно находятся на линии и опрашивают нас раз в минуту, чтобы узнать, какой заказ им в данный момент назначен.
- Также заказчики могут отменять заказы. В этом случае заказ получает статус отмененного, больше с этим заказом ничего не происходит, его исполнитель становится свободным.

###### Требования по платформам (desktop, mobile и т.д.)

Нам это не актуально, мы никак не различаем трафик desktop/mobile.


#### Нефункциональные требования

###### Взаимодействие с источниками

Наш сервис должен получать данные из пяти источников:

1. начальная конфигурация сервера (`config`)
2. данные о заказе (`order`)
3. повышающий коэффициент зоны заказа (`zone`)
4. данные о платных дорогах в зоне заказа (`toll-roads`)
5. данные об исполнителе (`executor`)
6. фоллбэк-источник данных об исполнителе (`executor-fallback`)

Цена заказа формируется из источников 2-4.

###### Latency

Latency не должно расти при длительной нагрузке с rps не более, чем заданным.

###### Масштабируемость

- 100 rps на создание заказов
- 8333 rps на узнавание исполнителями статусов
- 50 rps на отмену заказов

Система должна линейно масштабироваться к нагрузке (TODO это тут оставляем, а что именно это значит? что можем долить железа и максимальный rps увеличится линейно?)

###### Отказоустойчивость

Источник `order` является *критичным*. Это значит, что его ответы нужны всегда в самом свежем виде, нельзя применять кэширование или использовать фоллбеки (дефолтное значение).

Остальные четыре источника *некритичные*. Это значит, что при их отказе их ответы можно заменять. А именно:

1. `config`: используем кэш, обновляемый каждую минуту.
2. `zone`: используем (TODO готовый?) LRU-кэш (TODO что это?). Данные старше 10 минут не используем, то есть в этом случае считаем, что данных нет.
3. `toll-roads`: используем кэш + фоллбэк, если в кэше ничего нет.
4. `executor`: поход на fallback-источник данных (`executor-fallback`).

###### Требования по срокам хранения данных

Бесконечно. Считаем, что 20 лет.


#### Решение

###### API

TODO внешнее API (3 ручки) максимально подробно (все коды ответов в разных случаях). Это Женя или Серёжа напишите пж.

###### Архитектура

TODO Сколько у нас микросервисов, какие микросервисы, какие БД, обязательно схема таблиц в БД. Точно нужно нарисовать схему. Подробнее, что нужно изобразить, есть на вики в конце страницы в разделе "Схема системы".

Основная БД -- БД заказов. Её схема: TODO.

Сервис должен состоять из двух микросервисов:
- Микросервис заказов. Занимается всем взаимодействием с БД заказов и вторым микросервисом. Не делает рассчет стоимости заказа и походы в источники.
- Всю логику походов в источники делает второй микросервис. То есть сами походы и принятие решений о замене ответа кэшом или фоллбэком. В БД заказов он не ходит. Для кэширования ответов тех источников, для которых это нужно, применяется TODO.

###### Протоколы взаимодействия микросервисов

TODO написать здесь что собираемся использовать grps и почему.

<!-- Особенности реализации точно не надо!! Это пойдет в отчет. -->
<!-- ###### Особенности реализации микросервиса заказов
TODO благодаря чему будет держаться требуемый rps; написать что делаем асинхронные запросы к второму сервису и к бд, мб написать про таймауты, сколько ждем ответов от второго сервиса и бд. 

###### Особенности реализации микросервиса источников
TODO благодаря чему будет держаться требуемый rps; написать что ходим в источники и кэши асинхронно, по какой формуле считаем цену, сколько ждем ответ от источников. -->

###### Рассчет нагрузки

<!-- НЕ НАДО делать здесь подробные рассчеты железа!! Потому что это невозможно сделать, это будет в отчете. -->

TODO написать здесь, сколько rps на каждую ручку, в том числе на второй микросервис. Также подробно рассчитать требуемый объем хранилища в БД.


<!-- Про тесты здесь ничего не надо, это пойдет в отчет!! -->
<!-- #### Тесты

###### Заглушки источников данных 
Для эмуляции источников данных в тестах мы используем заглушки. TODO написать про то, как реализованы заглушки.

###### Функциональные
TODO Написать про тесты на второй микросервис + тесты на весь сервис вместе (ну то есть на первый микросервис, но он ходит во второй). С помощью чего проводились, то есть какой язык, инструмент или тп.

###### Нагрузочные
TODO Написать про нагрузочные тесты на весь наш сервис вместе. С помощью какого инструмента проводились, . -->
